{
  "meta": {
    "instanceId": "n8n-webapp-fix"
  },
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ccbf1e03-2ef5-410a-8e81-03f8b1355393",
        "options": {}
      },
      "id": "webhook-trigger-webapp",
      "name": "Webhook Trigger - Web App",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [1000, 300],
      "webhookId": "ccbf1e03-2ef5-410a-8e81-03f8b1355393"
    },
    {
      "parameters": {
        "jsCode": "// This node converts base64 image to a URL that KIE.ai can use\n// It uploads the image to imgBB (free service) and returns the URL\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const productImage = item.json.product_image;\n  \n  // Check if product_image exists and has base64 data\n  if (!productImage) {\n    throw new Error('product_image field is missing from webhook data');\n  }\n  \n  // Extract base64 data (remove data:image/png;base64, prefix if present)\n  let base64Data = productImage;\n  if (base64Data.includes('base64,')) {\n    base64Data = base64Data.split('base64,')[1];\n  }\n  \n  // Upload to imgBB\n  const formData = new URLSearchParams();\n  formData.append('image', base64Data);\n  \n  const response = await fetch('https://api.imgbb.com/1/upload?key=d9766561db157236cc9151bb08020768', {\n    method: 'POST',\n    body: formData\n  });\n  \n  const result = await response.json();\n  \n  if (!result.success || !result.data || !result.data.url) {\n    throw new Error('Failed to upload image to imgBB: ' + JSON.stringify(result));\n  }\n  \n  // Return the image URL along with other form data\n  results.push({\n    json: {\n      ...item.json,\n      product_image_url: result.data.url,\n      product_name: item.json.product_name || '',\n      niche: item.json.niche || '',\n      country: item.json.country || '',\n      language: item.json.language || '',\n      amazon_link: item.json.amazon_link || '',\n      competitors_link_1: item.json['competitors_link_#1'] || ''\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "upload-image-to-url",
      "name": "Upload Base64 to URL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "jsCode": "// This node makes the KIE.ai image_input dynamic\n// It checks if we have product_image_url (from web app) or ClickUp data\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  let imageUrl;\n  \n  // Try to get image URL from web app upload\n  if (item.json.product_image_url) {\n    imageUrl = item.json.product_image_url;\n  }\n  // Fallback: Try to get from ClickUp (original workflow logic)\n  else if ($('Get a task').first()?.json?.custom_fields) {\n    const fields = $('Get a task').first().json.custom_fields;\n    const imageField = fields[11]; // Product image field\n    if (imageField && imageField.value && imageField.value[0]) {\n      imageUrl = imageField.value[0].url_w_host;\n    }\n  }\n  \n  if (!imageUrl) {\n    throw new Error('Could not find product image URL from either web app or ClickUp');\n  }\n  \n  // Pass through all data plus the image URL\n  results.push({\n    json: {\n      ...item.json,\n      resolved_image_url: imageUrl\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "resolve-image-url",
      "name": "Resolve Image URL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 1100]
    }
  ],
  "connections": {
    "Webhook Trigger - Web App": {
      "main": [[{
        "node": "Upload Base64 to URL",
        "type": "main",
        "index": 0
      }]]
    },
    "Upload Base64 to URL": {
      "main": [[{
        "node": "HTTP Request - AI Research",
        "type": "main",
        "index": 0
      }]]
    }
  }
}
